name: Auto Update Clash & Sing-box (Pro)

on:
  schedule:
    - cron: '0 0 * * *'  # هر روز ساعت 00:00 UTC
  workflow_dispatch:

jobs:
  update-config:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Ensure updater script exists
        run: |
          if [ ! -f update_clash_singbox.py ]; then
            echo "Creating update_clash_singbox.py..."
            cat << 'EOF' > update_clash_singbox.py
import yaml, json, requests, re, urllib.parse, socket, time

# لینک subscription
SUBS_URL = "https://raw.githubusercontent.com/igareck/vpn-configs-for-russia/refs/heads/main/BLACK_VLESS_RUS_mobile.txt"

# دانلود محتوا
resp = requests.get(SUBS_URL)
resp.raise_for_status()
lines = resp.text.strip().splitlines()

# اولویت کشورها
priority_countries = ["US", "DE", "FI", "RU", "IR"]

def extract_country(remark):
    for c in priority_countries:
        if c in remark.upper():
            return c
    return "ZZ"

# تست اتصال (Ping ساده TCP)
def test_latency(server, port, timeout=2):
    try:
        start = time.time()
        s = socket.create_connection((server, int(port)), timeout)
        s.close()
        return (time.time() - start)
    except:
        return float('inf')

proxies = []

for line in lines:
    if line.startswith("vless://"):
        match = re.match(r"vless://([0-9a-f-]+)@([^:]+):(\d+)\?([^#]+)#(.+)", line)
        if match:
            uuid, server, port, query, remark = match.groups()
            qs = urllib.parse.parse_qs(query)
            net = qs.get("type", ["ws"])[0]
            flow = qs.get("flow", [None])[0]
            tls = qs.get("security", ["none"])[0] != "none"
            servername = qs.get("sni", [server])[0]
            latency = test_latency(server, port)
            proxies.append({
                "name": remark,
                "type": "vless",
                "server": server,
                "port": int(port),
                "uuid": uuid,
                "tls": tls,
                "flow": flow,
                "network": net,
                "servername": servername,
                "country": extract_country(remark),
                "latency": latency
            })

# مرتب‌سازی بر اساس اولویت کشور و latency
proxies.sort(key=lambda x: (priority_countries.index(x["country"]) if x["country"] in priority_countries else 99, x["latency"]))

# Clash config
clash_conf = {
    "allow-lan": True,
    "log-level": "info",
    "mode": "rule",
    "mixed-port": 7890,
    "tun": {
        "enable": True,
        "auto-route": True
    },
    "proxies": proxies,
    "proxy-groups": [
        {
            "name": "AUTO",
            "type": "select",
            "proxies": [p["name"] for p in proxies]
        },
        {
            "name": "BACKUP",
            "type": "fallback",
            "proxies": [p["name"] for p in proxies]
        }
    ],
    "rules": [
        "DOMAIN-SUFFIX,google.com,AUTO",
        "DOMAIN-SUFFIX,telegram.org,AUTO",
        "DOMAIN-SUFFIX,instagram.com,AUTO",
        "DOMAIN-KEYWORD,iran,BACKUP",
        "FINAL,BACKUP"
    ]
}

with open("clash.yaml", "w") as f:
    yaml.safe_dump(clash_conf, f, default_flow_style=False, sort_keys=False)

# Sing-box config
singbox_conf = {"outbounds": proxies}
with open("singbox.json", "w") as f:
    json.dump(singbox_conf, f, indent=2)

print(f"Generated clash.yaml and singbox.json with {len(proxies)} proxies.")
EOF

      - name: Run Clash/Sing-box updater
        run: python update_clash_singbox.py

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          [ -f clash.yaml ] && git add clash.yaml
          [ -f singbox.json ] && git add singbox.json
          git commit -m "Auto update Clash & Sing-box configs" || echo "No changes to commit"
          git push || echo "Nothing to push"
